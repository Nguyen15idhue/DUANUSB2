<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" 
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="USB Dongle Sync Service" 
           Manufacturer="CHC Geomatics" 
           Version="1.0.0.0" 
           UpgradeCode="B5F8E7D4-3C2A-4F1B-9E8D-7A6B5C4D3E2F"
           Language="1033"
           Compressed="yes">
    
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    
    <MediaTemplate EmbedCab="yes" />
    
    <!-- Icon for Add/Remove Programs -->
    <Icon Id="ServiceIcon" SourceFile="$(var.SourceDir)\icon.ico" />
    <Property Id="ARPPRODUCTICON" Value="ServiceIcon" />
    
    <!-- Installation directory -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="CompanyFolder" Name="CHC Geomatics">
        <Directory Id="INSTALLFOLDER" Name="Dongle Service" />
      </Directory>
    </StandardDirectory>
    
    <!-- Data directory -->
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="DataFolder" Name="DongleSyncService">
        <Directory Id="BackupFolder" Name="backups" />
        <Directory Id="LogsFolder" Name="logs" />
      </Directory>
    </StandardDirectory>
    
    <!-- Main installation component -->
    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <Component Id="ServiceExecutable" Guid="A1B2C3D4-E5F6-4A5B-8C7D-9E0F1A2B3C4D">
        <File Id="ServiceExe" Source="$(var.SourceDir)\DongleSyncService.exe" KeyPath="yes" />
        
        <!-- Install as Windows Service -->
        <ServiceInstall Id="DongleServiceInstaller"
                       Name="DongleSyncService"
                       DisplayName="USB Dongle Sync Service"
                       Description="Manages USB dongle for CHC Geomatics Office licensing"
                       Type="ownProcess"
                       Start="auto"
                       Account="LocalSystem"
                       ErrorControl="normal"
                       Interactive="no" />
        
        <!-- Service control -->
        <ServiceControl Id="DongleServiceControl"
                       Name="DongleSyncService"
                       Start="install"
                       Stop="both"
                       Remove="uninstall"
                       Wait="yes" />
      </Component>
      
      <!-- Additional DLLs and dependencies -->
      <Component Id="Dependencies" Guid="B2C3D4E5-F6A7-5B6C-9D8E-0F1A2B3C4D5E">
        <File Source="$(var.SourceDir)\*.dll" />
        <File Source="$(var.SourceDir)\*.pdb" />
      </Component>
    </ComponentGroup>
    
    <!-- Data folder components -->
    <ComponentGroup Id="DataComponents" Directory="DataFolder">
      <Component Id="DataFolderComponent" Guid="C3D4E5F6-A7B8-6C7D-0E9F-1A2B3C4D5E6F">
        <CreateFolder>
          <Permission User="Everyone" GenericAll="yes" />
        </CreateFolder>
      </Component>
    </ComponentGroup>
    
    <ComponentGroup Id="BackupComponents" Directory="BackupFolder">
      <Component Id="BackupFolderComponent" Guid="D4E5F6A7-B8C9-7D8E-1F0A-2B3C4D5E6F7A">
        <CreateFolder>
          <Permission User="Everyone" GenericAll="yes" />
        </CreateFolder>
      </Component>
    </ComponentGroup>
    
    <ComponentGroup Id="LogsComponents" Directory="LogsFolder">
      <Component Id="LogsFolderComponent" Guid="E5F6A7B8-C9D0-8E9F-2A1B-3C4D5E6F7A8B">
        <CreateFolder>
          <Permission User="Everyone" GenericAll="yes" />
        </CreateFolder>
      </Component>
    </ComponentGroup>
    
    <!-- Feature definition -->
    <Feature Id="ProductFeature" Title="USB Dongle Sync Service" Level="1">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="DataComponents" />
      <ComponentGroupRef Id="BackupComponents" />
      <ComponentGroupRef Id="LogsComponents" />
    </Feature>
    
    <!-- UI -->
    <UI>
      <UIRef Id="WixUI_Minimal" />
      <Publish Dialog="ExitDialog"
               Control="Finish"
               Event="DoAction"
               Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
    </UI>
    
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Start USB Dongle Sync Service now" />
    
    <!-- Launch application on finish -->
    <CustomAction Id="LaunchApplication"
                  Directory="INSTALLFOLDER"
                  ExeCommand="net start DongleSyncService"
                  Execute="immediate"
                  Return="asyncNoWait" />
  </Package>
</Wix>
